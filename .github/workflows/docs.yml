name: docs

on:
  push:
    branches: [master]
    paths:
      - "lua/**/*.lua"
      - ".github/workflows/docs.yml"

permissions:
  contents: write

jobs:
  docs:
    runs-on: ubuntu-latest
    name: Generate vimdoc
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: ${{ runner.os }}-cargo-vimcats-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-vimcats-

      - name: Install vimcats
        run: cargo install vimcats --features=cli

      - name: Generate vimdoc
        run: |
          vimcats -c -f \
            lua/search-replace/init.lua \
            lua/search-replace/core.lua \
            > doc/search-replace.txt

      - name: Commit changes
        id: auto-commit
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs: auto-generate vimdoc"
          file_pattern: doc/*.txt
          disable_globbing: true
